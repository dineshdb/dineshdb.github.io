---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import NowCard from "../components/NowCard.astro";
import BlogCard from "../components/BlogCard.astro";
import SectionHeader from "../components/SectionHeader.astro";
import { renderUpdates } from "../utils/renderUpdates";
import { withBlogUrls } from "../utils/content";

const title = "Now";
const description = "What I'm doing now — updates over time";
const permalink = `/now`;

const allUpdates = await getCollection("now");
const updates = allUpdates.sort((a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf());

// Get tags from now updates to exclude from "Other Posts"
const nowTags = new Set(updates.flatMap(u => u.data.tags || []));

// Get 2 most recent blog posts that don't overlap with now topics
const recentBlogs = withBlogUrls(
  (await getCollection("blog"))
    .filter(post => !post.data.tags?.some(tag => nowTags.has(tag)))
    .sort((a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf())
    .slice(0, 2)
);

// Render all update contents upfront
const renderedUpdates = await renderUpdates(updates);
---

<BaseLayout
  title={title}
  description={description}
  permalink={permalink}
  current="now"
>
  <div class="max-w-2xl mx-auto">
    <div class="mb-8">
      <h1 class="text-xl font-bold text-stone-900 dark:text-stone-100">
        Now
      </h1>
      <p class="text-stone-600 dark:text-stone-400 text-sm">
        Updates about what I'm doing, thinking, and exploring.
      </p>
    </div>

    <div class="grid grid-cols-1 gap-4">
      {renderedUpdates.map(({ update, content: Content }) => (
        <NowCard update={update} content={Content} />
      ))}
    </div>

    {recentBlogs.length > 0 && (
      <div class="mt-16 pt-8">
        <SectionHeader title="Other Posts" linkUrl="/blog" linkText="View all posts →" />
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          {recentBlogs.map((post) => (
            <BlogCard post={post} />
          ))}
        </div>
      </div>
    )}
  </div>
</BaseLayout>
